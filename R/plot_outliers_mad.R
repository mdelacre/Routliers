#' Plotting function for the mad
#'
#' plotting data and highlighting univariate outliers detected with the MAD function
#'
#' @param data vector of numeric values from which we want to compute outliers
#' @param b constant depending on the assumed distribution underlying the data, that equals 1/Q(0.75).  When the normal distribution is assumed, the constant 1.4826 is used (and it makes the MAD and SD of normal distributions comparable).
#' @param threshold the number of MAD considered as a threshold to consider a value an outlier
#' @param na.rm set whether Missing Values should be excluded (na.rm=TRUE) or not (na.rm=FALSE) - defaults to TRUE
#' @param verbose logical variable indicating whether text output should be generated (verbose = TRUE) or not (verbose = FALSE) - default to TRUE
#'
#' @export plot_outliers_mad
#' @keywords plot MAD outliers
#' @return None
#' @examples
#' Run plot_outliers_mad
#' plot_outliers_mad(data=runif(150,-100,100), b=1.4826,threshold=3,na.rm=TRUE,verbose=TRUE)
#' plot_outliers_mad(data=Intentions$age)
#' plot_outliers_mad(data=Intentions$Total_Amount_Earned)
#' ls(Attacks)
#' SOC=rowMeans(Attacks[,c("soc1r","soc2r","soc3r","soc4","soc5","soc6","soc7r","soc8","soc9","soc10r","soc11","soc12","soc13")])
#' plot_outliers_mad(data=SOC)
#'
#' @importFrom stats na.omit
#' @importFrom graphics par points rect segments text title

plot_outliers_mad=function(data,
                      b = 1.4826,
                      threshold=3,
                      na.rm = TRUE,
                      verbose = TRUE){

  if(inherits(data,c("numeric","integer"))==FALSE) stop("Data are neither numeric nor integer")

  if (na.rm==TRUE) {
    dat=na.omit(data)
  } else {dat=data}

  # Calculate the MAD
  center=median(dat)
  MAD=b*median(abs(dat-center))
  half_CI=threshold*MAD

  # Calculate the range of acceptable values
  LL_CI_MAD=center-half_CI
  UL_CI_MAD=center+half_CI

  # calculate the outliers
  outliers=c(dat[dat<LL_CI_MAD],dat[dat>UL_CI_MAD])
  outliers_pos=c(which(dat<LL_CI_MAD),which(dat>UL_CI_MAD))

  #ylim=c(min(min(dat),LL_CI_MAD)-1.5*abs(min(min(dat),LL_CI_MAD)),max(max(dat),UL_CI_MAD)+1.5*abs(max(max(dat),UL_CI_MAD)))
  # plotting results
    par(mar=c(5.1,3.1,5.1,1.1))
    plot(NA,xlim=c(min(min(dat),LL_CI_MAD)-.1*(max(dat)-min(dat)),max(max(dat),UL_CI_MAD)+.1*(max(dat)-min(dat))),ylim=c(0,1), bty="n",yaxt="n", ylab="",xlab="")
    rect(LL_CI_MAD,.25,UL_CI_MAD,.45,col = "lightgrey", border = "lightgrey", lwd = par("lwd"))

    if(LL_CI_MAD!=UL_CI_MAD){
    segments(LL_CI_MAD,0.25,LL_CI_MAD,0.45, lwd=1)
    text(LL_CI_MAD,.45,"lower CI limit",lwd=1,pos=3,cex=.75)
    segments(UL_CI_MAD,0.25,UL_CI_MAD,0.45, lwd=1)
    text(UL_CI_MAD,.45,"upper CI limit",lwd=1,pos=3,cex=.75)
    segments(center,0.25,center,0.45, lwd=3,col="red")
    text(center,.45,"median",lwd=1,pos=3,cex=.75,col="red")
    } else if (LL_CI_MAD==UL_CI_MAD){
      segments(LL_CI_MAD,0.25,LL_CI_MAD,0.45, lwd=1)
      text(LL_CI_MAD,.45,paste0("lower = upper","\n","CI limit"),lwd=1,pos=3,cex=.75)
    }
    if (length(outliers)!=0){
        points(dat[outliers_pos],rep(.35,length(outliers_pos)),col="red",bg="red",pch=19,cex=.5)}

        title(main=paste("Detecting values out of the Confidence Interval \n CI = Median","\u00B1",threshold," MAD"))

        if(length(dat[outliers_pos])==0){comment="No outliers are detected"
        } else {comment=paste(length(outliers),"outliers are detected")}

        legend("top",comment,pch=1,col="white",cex=1,bty="n")
}


